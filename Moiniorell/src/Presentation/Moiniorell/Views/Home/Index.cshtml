@using Humanizer
@inject UserManager<AppUser> _userManager
@{
    AppUser user = await _userManager.FindByNameAsync(User.Identity.Name);
}

@model HomeVM
<!-- Page Content  -->
<div id="content-page" class="content-page">
    <div class="container">
        <div class="row">
            <div class="col-lg-9 row m-0 p-0">
                <div class="col-sm-12">
                    <div id="post-modal-data" class="iq-card iq-card-block iq-card-stretch iq-card-height">
                        <div class="iq-card-header d-flex justify-content-between">
                            <div class="iq-header-title">
                                <h4 class="card-title">Create Post</h4>
                            </div>
                        </div>
                        <div class="iq-card-body" data-toggle="modal" data-target="#post-modal">
                            <div class="d-flex align-items-center">
                                <div class="user-img">
                                    <img src="~/assets/images/@user.ProfilePicture" alt="userimg" class="avatar-60 rounded-circle">
                                </div>
                                <form method="post" enctype="multipart/form-data" class="post-text ml-3 w-100">
                                    <div class="row">
                                        <input asp-for="CreatePostVM.Text" name="Text" class="form-control rounded" placeholder="Write something here..." style="border:none;">
                                    </div>
                                    <div class="row justify-content-end mt-3">
                                        <ul class="post-opt-block d-flex align-items-center list-inline m-0 p-0">
                                            <li class="iq-bg-primary rounded p-2 pointer mr-3">
                                                @* <label for="fileInput" style="cursor: pointer;">
                                                <img src="~/assets/images/small/07.png" alt="icon" class="img-fluid"> Photo (Must be 4:3 ratio)
                                                </label>
                                                <input type="file" id="fileInput" name="File" asp-for="CreatePostVM.File" style="opacity: 0; position: absolute; z-index: -1;" />
                                                *@

                                                <label for="fileInput" style="cursor: pointer;">
                                                    <img src="~/assets/images/small/07.png" alt="icon" class="img-fluid"> Photo/Video
                                                </label>

                                                <input type="file" id="fileInput" name="File" asp-for="CreatePostVM.File" style="opacity: 0; position: absolute; z-index: -1;" />

                                                <div class="modal" id="cropModal" tabindex="-1" role="dialog">
                                                    <div class="modal-dialog" role="document">
                                                        <div class="modal-content">
                                                            <div class="modal-body">
                                                                <div id="croppie-container"></div>
                                                            </div>
                                                            <div class="modal-footer">
                                                                <p> Image will be cropped and uploaded like this</p>
                                                                <button type="button" class="btn btn-primary" id="cropButton">Crop</button>
                                                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

                                                <script>
                                                    $(document).ready(function () {
                                                        $('#fileInput').on('change', function (e) {
                                                            var input = e.target;
                                                            var reader = new FileReader();

                                                            reader.onload = function () {
                                                                var imageUrl = reader.result;
                                                                console.log('Image loaded:', imageUrl);

                                                                $('#croppie-container').empty();
                                                                $('#cropModal').modal('show');

                                                                var container = $('<div>').css({
                                                                    'width': '640px',
                                                                    'height': '480px',
                                                                    'overflow': 'hidden',
                                                                    'position': 'relative'
                                                                });

                                                                var img = $('<img>').attr('src', imageUrl).css({
                                                                    'width': '100%',
                                                                    'height': '100%',
                                                                    'object-fit': 'cover',
                                                                    'object-position': 'center'
                                                                });

                                                                container.append(img);
                                                                $('#croppie-container').append(container);

                                                                $('#cropButton').on('click', function () {
                                                                    var croppedImageSrc = imageUrl;
                                                                    console.log('Cropped Image:', croppedImageSrc);
                                                                    $('#cropModal').modal('hide');
                                                                });
                                                            };

                                                            reader.readAsDataURL(input.files[0]);
                                                        });

                                                        $('#cropModal').on('hidden.bs.modal', function () {
                                                            $('#croppie-container').empty();
                                                        });
                                                    });
                                                </script>




                                            </li>
                                        </ul>

                                        <button class="btn btn-primary d-block" type="submit">Submit</button>
                                    </div>
                                </form>



                            </div>
                            <hr>


                        </div>
                    </div>
                </div>
                @foreach (var item in Model.Posts)

                {

                    <div class="col-sm-12">
                        <div class="iq-card iq-card-block iq-card-stretch iq-card-height">
                            <div class="iq-card-body">
                                <div class="user-post-data">
                                    <div class="d-flex flex-wrap">
                                        <div class="media-support-user-img mr-3">
                                            <img class="rounded-circle img-fluid" src="~/assets/images/@item.Author.ProfilePicture" alt="">
                                        </div>
                                        <div class="media-support-info mt-2">
                                            <h5 class="mb-0 d-inline-block"><a href="#" class="">@item.Author.Name @item.Author.Surname</a></h5>
                                            <p class="mb-0 d-inline-block">Add New Post</p>
                                            <p class="mb-0 text-primary">
                                                <span class="time-ago">@item.CreatedAt.Humanize()</span>
                                            </p>
                                        </div>



                                    </div>
                                </div>
                                <div class="mt-3">
                                    <p>@item.Text</p>
                                </div>
                                <div class="user-post">
                                    <div class="d-flex justify-content-center">
                                        <div style="width: 640px; height: 480px;">

                                            <img src="~/assets/images/@item.Image" alt="post-image" class="img-fluid rounded zoom-image" style="width: 640px; height: 480px; object-fit: contain;">

                                        </div>
                                    </div>
                                </div>


                                <div class="comment-area mt-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="like-block position-relative d-flex align-items-center">
                                            <div class="d-flex align-items-center like-section" data-post-id="@item.Id">
                                                <div class="like-data">
                                                    <div class="dropdown">
                                                        @if (item.Likes.Any(like => like.LikerId == user.Id))
                                                        {
                                                            <span>
                                                                <a href="#" class="likeToggle" data-post-id="@item.Id" data-liked="true">
                                                                    <img src="~/assets/images/icon/01.png" class="img-fluid" alt="">
                                                                    <span class="toggle-text">@((item.Likes.Any(like => like.LikerId == user.Id)) ? "Unlike" : "Like")</span>
                                                                </a>
                                                            </span>
                                                        }
                                                        else
                                                        {
                                                            <span>
                                                                <a href="#" class="likeToggle" data-post-id="@item.Id" data-liked="false">
                                                                    <img src="~/assets/images/icon/01.png" class="img-fluid" alt="">
                                                                    <span class="toggle-text">@((item.Likes.Any(like => like.LikerId == user.Id)) ? "Unlike" : "Like")</span>
                                                                </a>
                                                            </span>
                                                        }
                                                    </div>

                                                </div>
                                                <div class="total-like-block ml-2 mr-3">
                                                    <div class="dropdown">
                                                        <span class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" role="button">
                                                            @item.LikeCount
                                                        </span>
                                                        <div class="dropdown-menu">
                                                            @if (item.Likes.Any())
                                                            {
                                                                @foreach (var like in item.Likes.TakeLast(5))
                                                                {
                                                                    <a class="dropdown-item">@like.Liker.Name @like.Liker.Surname</a>
                                                                }
                                                            }
                                                            else
                                                            {
                                                                <a class="dropdown-item">No likes for now</a>
                                                            }
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            @*  <div class="d-flex align-items-center">
                                        <div class="like-data">
                                        <div class="dropdown">
                                        @if (item.Likes.Any(like => like.LikerId == user.Id))
                                        {
                                        <span>
                                        <a href="#" class="unlikeButton" data-post-id="@item.Id">
                                        <img src="~/assets/images/icon/01.png" class="img-fluid" alt=""> Unlike
                                        </a>
                                        </span>
                                        }
                                        else
                                        {
                                        <span>
                                        <a href="#" class="likeButton" data-post-id="@item.Id">
                                        <img src="~/assets/images/icon/01.png" class="img-fluid" alt=""> Like
                                        </a>
                                        </span>
                                        }



                                        </div>
                                        </div>
                                        <div class="total-like-block ml-2 mr-3">
                                        <div class="dropdown">
                                        <span class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" role="button">
                                        @item.LikeCount
                                        </span>
                                        <div class="dropdown-menu">
                                        @if (item.Likes.Any())
                                        {

                                        @foreach (var like in item.Likes.TakeLast(5))
                                        {
                                        <a class="dropdown-item">@like.Liker.Name @like.Liker.Surname</a>
                                        }
                                        }
                                        else
                                        {
                                        <a class="dropdown-item">No likes for now</a>

                                        }
                                        </div>
                                        </div>
                                        </div>
                                        </div> *@
                                            <div class="total-comment-block">
                                                <div class="dropdown">
                                                    <span class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" role="button">
                                                        @if (item.Comments is not null)
                                                        {
                                                            <span>@item.Comments.Count() Comments</span>

                                                        }
                                                        else
                                                        {
                                                            <span> No comments </span>
                                                        }
                                                    </span>
                                                    <div class="dropdown-menu">
                                                        @foreach (var comuser in item.Comments.TakeLast(5))
                                                        {
                                                            <a class="dropdown-item">@comuser.Author.Name @comuser.Author.Surname</a>
                                                        }
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                    <hr>
                                    <ul class="post-comments p-0 m-0">
                                        @foreach (var comm in item.Comments)
                                        {
                                            <li class="mb-2">
                                                <div class="d-flex flex-wrap">
                                                    <div class="user-img">
                                                        <img src="~/assets/images/@comm.Author.ProfilePicture" alt="userimg" class="avatar-35 rounded-circle img-fluid">
                                                    </div>
                                                    <div class="comment-data-block ml-3">
                                                        <h6>@comm.Author.Name @comm.Author.Surname </h6>
                                                        <p class="mb-0">@comm.Text</p>
                                                        <div class="d-flex flex-wrap align-items-center comment-activity">
                                                            <a href="#">like</a>
                                                            <a href="#" id="openFormLink">reply</a>
                                                            <span> @comm.CreatedAt.Humanize() </span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="replies" style="margin-left: 36px;">
                                                    @foreach (var reply in comm.Replies.Take(3)) // Only take the first 5 replies
                                                    {
                                                        <div class="d-flex flex-wrap">

                                                            <div class="comment-data-block ml-3">

                                                                <h6>@reply.Author.Name @reply.Author.Surname <span style="color: #808080; font-style: italic; font-weight: lighter;"> @reply.CreatedAt.Humanize() </span></h6>
                                                                <p class="mb-0">@reply.Text</p>

                                                            </div>
                                                        </div>
                                                    }

                                                    <div class="load-more-container">
                                                        <div class="additional-replies" id="additional-replies-@comm.Id" style="display: none;">
                                                            @foreach (var reply in comm.Replies.Skip(3))
                                                            {
                                                                <div class="d-flex flex-wrap">
                                                                    <div class="comment-data-block ml-3">
                                                                        <h6>@reply.Author.Name @reply.Author.Surname <span style="color: #808080; font-style: italic; font-weight: lighter;"> @reply.CreatedAt.Humanize() </span></h6>
                                                                        <p class="mb-0">@reply.Text</p>
                                                                    </div>
                                                                </div>
                                                            }
                                                        </div>
                                                        @if (comm.Replies.Count() > 3)
                                                        {

                                                            <button class="btn btn-link load-more-button" style="margin-left: 2px;" data-comment-id="@comm.Id">Load More</button>
                                                        }

                                                    </div>

                                                    <script>
                                                        $(document).ready(function () {
                                                            $(".load-more-button").off("click").on("click", function (event) {
                                                                event.preventDefault();
                                                                var commentId = $(this).data("comment-id");
                                                                console.log("Load more button clicked for comment id: " + commentId);
                                                                var additionalReplies = $("#additional-replies-" + commentId);
                                                                console.log("Is additional replies visible? " + additionalReplies.is(":visible"));
                                                                additionalReplies.stop().slideToggle();
                                                            });
                                                        });
                                                    </script>



                                                </div>


                                                @await Html.PartialAsync("_CreateReplyForm", new CreateReplyVM { CommentId = comm.Id })

                                            </li>

                                        }
                                    </ul>
                                    @await Html.PartialAsync("_CreateCommentForm", new CreateCommentVM { PostId = item.Id })
                                    @* <form class="comment-text d-flex align-items-center mt-3" asp-controller="Comment" asp-action="CreateComment" method="post">
                                <input asp-for="CreateCommentVM.Text" class="form-control rounded">
                                <input asp-for="CreateCommentVM.PostId" value="@item.Id" hidden/>
                                <div class="comment-attagement d-flex">
                                <button type="submit"><i class="fa fa-paper-plane" aria-hidden="true"></i></button>
                                </div>
                                </form>  *@
                                </div>
                            </div>
                        </div>
                    </div>

                }


            </div>
            <div class="col-lg-3">
                <div class="iq-card">
                    <div class="iq-card-header d-flex justify-content-between">
                        <div class="iq-header-title">
                            <h4 class="card-title">Stories</h4>
                        </div>
                    </div>
                    <div class="iq-card-body">
                        <ul class="media-story m-0 p-0">
                            <li class="d-flex mb-4 align-items-center">
                                <i class="ri-add-line font-size-18"></i>
                                <div class="stories-data ml-3">
                                    <h5>Creat Your Story</h5>
                                    <p class="mb-0">time to story</p>
                                </div>
                            </li>
                            <li class="d-flex mb-4 align-items-center active">
                                <img src="~/assets/images/page-img/s2.jpg" alt="story-img" class="rounded-circle img-fluid">
                                <div class="stories-data ml-3">
                                    <h5>Anna Mull</h5>
                                    <p class="mb-0">1 hour ago</p>
                                </div>
                            </li>
                            <li class="d-flex mb-4 align-items-center">
                                <img src="~/assets/images/page-img/s3.jpg" alt="story-img" class="rounded-circle img-fluid">
                                <div class="stories-data ml-3">
                                    <h5>Ira Membrit</h5>
                                    <p class="mb-0">4 hour ago</p>
                                </div>
                            </li>
                            <li class="d-flex align-items-center">
                                <img src="~/assets/images/page-img/s1.jpg" alt="story-img" class="rounded-circle img-fluid">
                                <div class="stories-data ml-3">
                                    <h5>Bob Frapples</h5>
                                    <p class="mb-0">9 hour ago</p>
                                </div>
                            </li>
                        </ul>
                        <a href="#" class="btn btn-primary d-block mt-3">See All</a>
                    </div>
                </div>
                <div class="iq-card">
                    <div class="iq-card-header d-flex justify-content-between">
                        <div class="iq-header-title">
                            <h4 class="card-title">Events</h4>
                        </div>
                        <div class="iq-card-header-toolbar d-flex align-items-center">
                            <div class="dropdown">
                                <span class="dropdown-toggle" id="dropdownMenuButton" data-toggle="dropdown" aria-expanded="false" role="button">
                                    <i class="ri-more-fill"></i>
                                </span>
                                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuButton" style="">
                                    <a class="dropdown-item" href="#"><i class="ri-eye-fill mr-2"></i>View</a>
                                    <a class="dropdown-item" href="#"><i class="ri-delete-bin-6-fill mr-2"></i>Delete</a>
                                    <a class="dropdown-item" href="#"><i class="ri-pencil-fill mr-2"></i>Edit</a>
                                    <a class="dropdown-item" href="#"><i class="ri-printer-fill mr-2"></i>Print</a>
                                    <a class="dropdown-item" href="#"><i class="ri-file-download-fill mr-2"></i>Download</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="iq-card-body">
                        <ul class="media-story m-0 p-0">
                            <li class="d-flex mb-4 align-items-center ">
                                <img src="~/assets/images/page-img/s4.jpg" alt="story-img" class="rounded-circle img-fluid">
                                <div class="stories-data ml-3">
                                    <h5>Web Workshop</h5>
                                    <p class="mb-0">1 hour ago</p>
                                </div>
                            </li>
                            <li class="d-flex align-items-center">
                                <img src="~/assets/images/page-img/s5.jpg" alt="story-img" class="rounded-circle img-fluid">
                                <div class="stories-data ml-3">
                                    <h5>Fun Events and Festivals</h5>
                                    <p class="mb-0">1 hour ago</p>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="iq-card">
                    <div class="iq-card-header d-flex justify-content-between">
                        <div class="iq-header-title">
                            <h4 class="card-title">Upcoming Birthday</h4>
                        </div>
                    </div>
                    <div class="iq-card-body">
                        <ul class="media-story m-0 p-0">
                            <li class="d-flex mb-4 align-items-center">
                                <img src="~/assets/images/user/01.jpg" alt="story-img" class="rounded-circle img-fluid">
                                <div class="stories-data ml-3">
                                    <h5>Anna Sthesia</h5>
                                    <p class="mb-0">Today</p>
                                </div>
                            </li>
                            <li class="d-flex align-items-center">
                                <img src="~/assets/images/user/02.jpg" alt="story-img" class="rounded-circle img-fluid">
                                <div class="stories-data ml-3">
                                    <h5>Paul Molive</h5>
                                    <p class="mb-0">Tomorrow</p>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="iq-card">
                    <div class="iq-card-header d-flex justify-content-between">
                        <div class="iq-header-title">
                            <h4 class="card-title">Suggested Pages</h4>
                        </div>
                        <div class="iq-card-header-toolbar d-flex align-items-center">
                            <div class="dropdown">
                                <span class="dropdown-toggle" id="dropdownMenuButton01" data-toggle="dropdown" aria-expanded="false" role="button">
                                    <i class="ri-more-fill"></i>
                                </span>
                                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuButton01" style="">
                                    <a class="dropdown-item" href="#"><i class="ri-eye-fill mr-2"></i>View</a>
                                    <a class="dropdown-item" href="#"><i class="ri-delete-bin-6-fill mr-2"></i>Delete</a>
                                    <a class="dropdown-item" href="#"><i class="ri-pencil-fill mr-2"></i>Edit</a>
                                    <a class="dropdown-item" href="#"><i class="ri-printer-fill mr-2"></i>Print</a>
                                    <a class="dropdown-item" href="#"><i class="ri-file-download-fill mr-2"></i>Download</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="iq-card-body">
                        <ul class="suggested-page-story m-0 p-0 list-inline">
                            <li class="mb-3">
                                <div class="d-flex align-items-center mb-3">
                                    <img src="~/assets/images/page-img/42.png" alt="story-img" class="rounded-circle img-fluid avatar-50">
                                    <div class="stories-data ml-3">
                                        <h5>Iqonic Studio</h5>
                                        <p class="mb-0">Lorem Ipsum</p>
                                    </div>
                                </div>
                                <img src="~/assets/images/small/img-1.jpg" class="img-fluid rounded" alt="Responsive image">
                                <div class="mt-3"><a href="#" class="btn d-block"><i class="ri-thumb-up-line mr-2"></i> Like Page</a></div>
                            </li>
                            <li class="">
                                <div class="d-flex align-items-center mb-3">
                                    <img src="~/assets/images/page-img/42.png" alt="story-img" class="rounded-circle img-fluid avatar-50">
                                    <div class="stories-data ml-3">
                                        <h5>Cakes & Bakes </h5>
                                        <p class="mb-0">Lorem Ipsum</p>
                                    </div>
                                </div>
                                <img src="~/assets/images/small/img-2.jpg" class="img-fluid rounded" alt="Responsive image">
                                <div class="mt-3"><a href="#" class="btn d-block"><i class="ri-thumb-up-line mr-2"></i> Like Page</a></div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-sm-12 text-center">
                <img src="~/assets/images/page-img/page-load-loader.gif" alt="loader" style="height: 100px;">
            </div>
        </div>
    </div>
</div>

@section likescripts {
    <script>
        $(document).ready(function () {
            console.log("Script loaded");

            $(document).on('click', '.likeToggle', function (e) {
                e.preventDefault();

                console.log("Like/Unlike button clicked");

                var likeToggleElement = $(this);
                var postId = likeToggleElement.data('post-id');
                var liked = likeToggleElement.data('liked');
                var postElement = likeToggleElement.closest('.like-section');
                var likeCountElement = postElement.find('.total-like-block span');
                var likersList = postElement.find('.dropdown-menu');

                // Toggle the state
                likeToggleElement.data('liked', !liked);
                likeToggleElement.find('.toggle-text').text(liked ? 'Like' : 'Unlike');

                // Send AJAX request to the server to update the database
                $.ajax({
                    url: liked ? '/Post/UnlikePost' : '/Post/LikePost',
                    type: 'POST',
                    data: { postId: postId },
                    success: function (data) {
                        console.log("AJAX success");

                        // Update the like count
                        var newLikeCount = parseInt(likeCountElement.text());
                        newLikeCount += liked ? -1 : 1;
                        likeCountElement.text(newLikeCount);

                        // Update likers list
                        if (data.likes && data.likes.length > 0) {
                            likersList.empty();
                            $.each(data.likes, function (index, like) {
                                var likerName = like.liker.name + ' ' + like.liker.surname;
                                likersList.append('<a class="dropdown-item">' + likerName + '</a>');
                            });
                        } else {
                            likersList.empty();
                            likersList.append('<a class="dropdown-item">No likes for now</a>');
                        }

                        // Server successfully updated, you may handle additional tasks if needed
                    },
                    error: function (error) {
                        console.error('Error:', error);
                        // Handle errors if necessary
                    }
                });
            });
        });
    </script>
}
